{% extends 'base.html' %}
{% load humanize static %}

{% block title %}Dashboard - Health Monitoring{% endblock %}

{% block body_class %}page-dashboard{% endblock %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Health Dashboard</h1>
        <div class="text-muted">Overview of recent health metrics and trends</div>
    </div>
    <div class="page-actions d-flex align-items-center gap-2">
        <a href="{% url 'health:health_report_pdf' %}?days=30" class="btn btn-sm btn-outline-light has-tooltip" data-tooltip="Export the last 30 days">
            <i class="fa-solid fa-file-pdf me-1"></i> Download Report
        </a>
        <a href="{% url 'health:log_data' %}" class="btn btn-sm btn-primary has-tooltip" data-tooltip="Add a new daily record">
            <i class="fa-solid fa-plus me-1"></i> Add Record
        </a>
    </div>
</div>

{% if not has_data %}
<div class="empty-state card">
    <div class="empty-icon"><i class="fa-solid fa-chart-line"></i></div>
    <div class="empty-title">No data yet</div>
    <div class="empty-subtitle">{{ message }}</div>
    <a href="{% url 'health:log_data' %}" class="btn btn-sm btn-primary mt-2">Add your first record</a>
</div>
{% else %}

<!-- KPI Row -->
<div class="kpi-grid mb-3">
    <div class="kpi-card">
        <div class="kpi-icon"><i class="fa-solid fa-heart text-white"></i></div>
        <div class="kpi-body">
            <div class="kpi-title">Average Heart Rate</div>
            <div class="kpi-value">{{ stats.avg_heart_rate|floatformat:0 }} bpm</div>
            <div class="kpi-delta">Latest reading: {{ latest_record.heart_rate|floatformat:0 }} bpm</div>
            <div class="kpi-trend {{ kpi_trends.heart_rate.css_class }}">
                <i class="fa-solid {{ kpi_trends.heart_rate.icon }}"></i>
                <span>{{ kpi_trends.heart_rate.label }}</span>
            </div>
        </div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon"><i class="fa-solid fa-bed text-white"></i></div>
        <div class="kpi-body">
            <div class="kpi-title">Average Sleep</div>
            <div class="kpi-value">{{ stats.avg_sleep|floatformat:1 }} hrs</div>
            <div class="kpi-delta">Tracked days: {{ stats.total_days }}</div>
            <div class="kpi-trend {{ kpi_trends.sleep.css_class }}">
                <i class="fa-solid {{ kpi_trends.sleep.icon }}"></i>
                <span>{{ kpi_trends.sleep.label }}</span>
            </div>
        </div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon"><i class="fa-solid fa-walking text-white"></i></div>
        <div class="kpi-body">
            <div class="kpi-title">Average Daily Steps</div>
            <div class="kpi-value">{{ stats.avg_steps|floatformat:0|intcomma }}</div>
            <div class="kpi-delta">Keep moving and build momentum</div>
            <div class="kpi-trend {{ kpi_trends.steps.css_class }}">
                <i class="fa-solid {{ kpi_trends.steps.icon }}"></i>
                <span>{{ kpi_trends.steps.label }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Alerts -->
{% if alerts.has_alert %}
<div class="alert-custom alert-warning">
    <strong>Recent Alerts</strong>
    <div class="mt-2">
        {% for message in alerts.messages %}
        <div class="message-bubble ai">{{ message }}</div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert-custom alert-success status-indicator">
    <span class="status-pill"><i class="fa-solid fa-check"></i> All Clear</span>
    <div class="status-text">Your latest health metrics are within normal ranges.</div>
    <div class="insight-subline" id="insightSubline">Compared to last week: --</div>
</div>
{% endif %}

<!-- Charts Row -->
<div class="row">
    <div class="col-lg-7">
        <div class="chart-card card">
            <div class="chart-header">
                <div>
                    <h2 class="mb-0">Heart Rate Trend</h2>
                    <div class="chart-subtitle">Daily averages</div>
                </div>
                <div class="chart-range">
                    <span class="range-label">Range</span>
                    <div class="range-tabs" aria-hidden="true">
                        <a class="range-btn {% if hr_range == 7 %}active{% endif %}" data-chart="hr" data-range="7" href="?hr_range=7&sleep_range={{ sleep_range }}&kpi_range={{ kpi_range }}&table_range={{ table_range }}">7d</a>
                        <a class="range-btn {% if hr_range == 30 %}active{% endif %}" data-chart="hr" data-range="30" href="?hr_range=30&sleep_range={{ sleep_range }}&kpi_range={{ kpi_range }}&table_range={{ table_range }}">30d</a>
                        <a class="range-btn {% if hr_range == 90 %}active{% endif %}" data-chart="hr" data-range="90" href="?hr_range=90&sleep_range={{ sleep_range }}&kpi_range={{ kpi_range }}&table_range={{ table_range }}">90d</a>
                    </div>
                </div>
            </div>
            <div id="heartRateChart" class="chart-canvas" data-chart-container="hr"></div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="chart-card card">
            <div class="chart-header">
                <div>
                    <h2 class="mb-0">Sleep Duration</h2>
                    <div class="chart-subtitle">Hours per night</div>
                </div>
                <div class="chart-range">
                    <span class="range-label">Range</span>
                    <div class="range-tabs" aria-hidden="true">
                        <a class="range-btn {% if sleep_range == 7 %}active{% endif %}" data-chart="sleep" data-range="7" href="?sleep_range=7&hr_range={{ hr_range }}&kpi_range={{ kpi_range }}&table_range={{ table_range }}">7d</a>
                        <a class="range-btn {% if sleep_range == 30 %}active{% endif %}" data-chart="sleep" data-range="30" href="?sleep_range=30&hr_range={{ hr_range }}&kpi_range={{ kpi_range }}&table_range={{ table_range }}">30d</a>
                        <a class="range-btn {% if sleep_range == 90 %}active{% endif %}" data-chart="sleep" data-range="90" href="?sleep_range=90&hr_range={{ hr_range }}&kpi_range={{ kpi_range }}&table_range={{ table_range }}">90d</a>
                    </div>
                </div>
            </div>
            <div id="sleepChart" class="chart-canvas" data-chart-container="sleep"></div>
        </div>
    </div>
</div>

<div id="recent-records-container" data-records-container>
    {% include 'health/partials/recent_records.html' %}
</div>

<div class="modal-backdrop" id="deleteModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
        <h3 id="deleteModalTitle">Delete record?</h3>
        <p class="text-muted mb-3">Are you sure you want to delete the record from <span id="deleteRecordDate">this date</span>?</p>
        <form method="post" id="confirmDeleteForm" action="#">
            {% csrf_token %}
            <div class="modal-actions">
                <button type="button" class="btn btn-sm btn-outline-light" id="cancelDelete">Cancel</button>
                <button type="submit" class="btn btn-sm btn-danger" id="confirmDelete">Delete</button>
            </div>
        </form>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
{% if has_data %}
<script>
    window.DASHBOARD_CONFIG = {
        chartEndpoint: "{% url 'health:dashboard_chart' %}",
        recordsEndpoint: "{% url 'health:dashboard_records' %}",
        charts: {
            hr: {
                elementId: "heartRateChart",
                title: "Heart Rate Trend",
                yTitle: "Heart Rate (bpm)",
                color: "#1cc7b7",
                type: "scatter",
                mode: "lines+markers",
                data: {
                    dates: {{ hr_chart_data.dates|safe }},
                    values: {{ hr_chart_data.values|safe }}
                }
            },
            sleep: {
                elementId: "sleepChart",
                title: "Sleep Duration Trend",
                yTitle: "Sleep Hours",
                color: "#f5c451",
                type: "bar",
                mode: "",
                data: {
                    dates: {{ sleep_chart_data.dates|safe }},
                    values: {{ sleep_chart_data.values|safe }}
                }
            }
        }
    };
</script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endif %}
{% endblock %}
